using System;
using System.IO;
using System.Runtime.InteropServices;
using System.Threading;
using System.Windows.Forms;

namespace WeAreDevs
{
    public class Execution
    {

        [DllImport("WeAreDevs_API-cpp.dll", CallingConvention = CallingConvention.Cdecl)]
        private static extern bool LaunchExploit();

        [DllImport("WeAreDevs_API-cpp.dll", CallingConvention = CallingConvention.Cdecl)]
        private static extern bool SendLuaCScript(string script);

        [DllImport("WeAreDevs_API-cpp.dll", CallingConvention = CallingConvention.Cdecl)]
        private static extern bool SendLuaScript(string script);

        [DllImport("WeAreDevs_API-cpp.dll", CallingConvention = CallingConvention.Cdecl)]
        private static extern bool isAPIAttached();

        public static void Execute(string script)
        {
            if (!isAPIAttached())
            {
                MessageBox.Show("You must be attached before attempting to execute a script!", "WeAreDevs - Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                Logger.WriteLine("You must be attached before attempting to execute a Lua script!", Logger.LogType.NEGATIVE, ConsoleColor.Red);
                return;
            }

            SendLuaScript(script);
            Logger.WriteLine($"Executed Lua script.\n\n{script}\n\n", Logger.LogType.POSITIVE, ConsoleColor.Green);
        }

        public static void ExecuteC(string script)
        {
            if (!isAPIAttached())
            {
                MessageBox.Show("You must be attached before attempting to execute a script!", "WeAreDevs - Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                Logger.WriteLine("You must be attached before attempting to execute a LuaC script!", Logger.LogType.NEGATIVE, ConsoleColor.Red);
                return;
            }

            SendLuaCScript(script);
            Logger.WriteLine($"Executed LuaC script.\n\n{script}\n\n", Logger.LogType.POSITIVE, ConsoleColor.Green);
        }

        public static void Attach()
        {
            LaunchExploit();
            Thread thread = new Thread(FreeFPS);
            thread.Start(thread);

            Logger.WriteLine("Successfully injected.", Logger.LogType.POSITIVE, ConsoleColor.Green);
        }

        private static void FreeFPS(object data)
        {
            Thread thread = data as Thread;
            Thread.Sleep(5000);
            if (Properties.Settings.Default.UnlockFPS)
            {
                Execute("set_fps_cap(999)\nprint(\"WeAreDevs has been attached! Freeing FPS...\")");
                Logger.WriteLine("Unlocked in-game frame rate.", Logger.LogType.POSITIVE, ConsoleColor.Green);
            }

            thread.Abort();
        }

        public static bool isAttached()
        {
            return isAPIAttached();
        }
    }
}
